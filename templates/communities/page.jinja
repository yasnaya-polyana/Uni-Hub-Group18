{% extends 'base/index.jinja' %}
{% include 'posts/post-logic.jinja' %}

{% block title %}
{{ community.name }}
{% endblock %}

{% block content %}
  <div class="max-w-6xl mx-auto">
    <!-- Community Header -->
    {% include 'communities/page-header.jinja' %}
    <!-- Main Content Area -->
    <div class="flex gap-4">
      <!-- Posts Column -->
      <div class="w-3/4">
        <!-- Create Post -->
        {% if is_member or is_owner or is_moderator or user.is_superuser %}
        <div class="card bg-base-100 shadow-lg mb-4">
          <div class="card-body">
            <!-- Collapsible toggle button - shown by default -->
            <div id="create-post-toggle" class="flex items-center cursor-pointer">
              <div class="avatar placeholder mr-2">
                <div class="w-8 rounded-full bg-neutral-focus text-neutral-content">
                  <span>{{ user.username|make_list|first|upper }}</span>
                </div>
              </div>
              <div class="p-3 bg-base-200 rounded-box w-full text-base-content/60 hover:bg-base-300">
                Create a post in {{ community.name }}...
              </div>
            </div>
            
            <!-- Expandable form - hidden by default -->
            <div id="create-post-form" class="hidden mt-4">
              <h2 class="card-title">Create a Post</h2>
              <form method="post">
                {% csrf_token %}

                <div class="space-y-4">
                  <div class="form-control">
                    <label class="label" for="{{ form.title.id_for_label }}">
                      <span class="label-text">{{ form.title.label }}</span>
                    </label>
                    {{ form.title }}
                    {% if form.title.errors %}
                      <label class="label">
                        <span class="label-text-alt text-error">{{ form.title.errors|join(", ") }}</span>
                      </label>
                    {% endif %}
                  </div>

                  <!-- Markdown Editor -->
                  <div class="form-control">
                    <label class="label" for="body">
                      <span class="label-text">Body</span>
                    </label>
            
                    <!-- Markdown Body -->
                    {% set editor_id = 'body' %}
                    {% set editor_name = 'body' %}
                    {% set editor_class = 'textarea textarea-bordered w-full' %}
            
                    {% include 'components/markdown-editor.jinja' %}
            
                    {% if form.body.errors %}
                      <label class="label">
                        <span class="label-text-alt text-error">{{ form.body.errors|join(", ") }}</span>
                      </label>
                    {% endif %}
                  </div>
                  <div class="card-actions justify-end mt-2">
                    <button type="button" id="cancel-post-btn" class="btn btn-ghost">Cancel</button>
                    <button type="submit" class="btn btn-primary">Post</button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
        {% endif %}
        <!-- Pinned Posts -->
        {% include 'communities/pinned-posts.jinja' %}
        <!-- Regular Posts -->
        <div class="flex flex-col space-y-4">
        {% include 'search/search.jinja' %}
        {% for post in posts.filter(is_pinned=False, parent_post__isnull=True) %}
          {% include 'posts/post.jinja' %}
        {% endfor %}
        </div>
      </div>
      <!-- Sidebar -->
      {% include 'communities/page-sidebar.jinja' %}
    </div>
  </div>

  <!-- Invite Modal -->
  {% if is_owner or is_moderator %}
  <div id="invite-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-base-100 p-6 rounded-box shadow-lg max-w-md w-full">
      <h3 class="font-bold text-lg mb-4">Invite Users to {{ community.name }}</h3>
      
      <form action="{{ url('community_invite', community.id) }}" method="post">
        {% csrf_token %}
        <div class="form-control mb-4">
          <label class="label">
            <span class="label-text">Username</span>
          </label>
          <input type="text" name="username" id="invite-username" placeholder="Enter username" class="input input-bordered w-full" required>
        </div>
        
        <div class="modal-action flex justify-between">
          <button type="button" id="close-invite-modal" class="btn">Cancel</button>
          <button type="submit" class="btn btn-primary">Send Invite</button>
        </div>
      </form>
    </div>
  </div>
  {% endif %}
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Post creation toggle functionality
      const createPostToggle = document.getElementById('create-post-toggle');
      const createPostForm = document.getElementById('create-post-form');
      const cancelPostBtn = document.getElementById('cancel-post-btn');
      
      if (createPostToggle && createPostForm) {
        // Show form when clicking the toggle button
        createPostToggle.addEventListener('click', function() {
          createPostToggle.classList.add('hidden');
          createPostForm.classList.remove('hidden');
          // Focus on title input after expanding
          const titleInput = document.getElementById('{{ form.title.id_for_label }}');
          if (titleInput) {
            titleInput.focus();
          }
        });
        
        // Hide form when clicking cancel
        if (cancelPostBtn) {
          cancelPostBtn.addEventListener('click', function() {
            createPostForm.classList.add('hidden');
            createPostToggle.classList.remove('hidden');
            // Reset form fields if needed
            document.querySelector('form').reset();
          });
        }
      }
      
      // Invite functionality
      const inviteBtn = document.getElementById('invite-users-btn');
      const inviteModal = document.getElementById('invite-modal');
      const closeInviteModal = document.getElementById('close-invite-modal');
      
      if (inviteBtn && inviteModal) {
        inviteBtn.addEventListener('click', function() {
          inviteModal.classList.remove('hidden');
          inviteModal.classList.add('flex');
        });
        
        closeInviteModal.addEventListener('click', function() {
          inviteModal.classList.add('hidden');
          inviteModal.classList.remove('flex');
          document.getElementById('invite-username').value = '';
        });
      }
    });
  </script>
  {% endblock %}